sudo: required
language: python
python:
  - "3.6"
install:
  - pip install -r requirements.txt
services:
  - docker
jobs:
  include:
    - stage: import
      script:
        - scripts/import_questions.py

    - stage: test
      script:
        - echo "$DOCKER_PASSWD" | docker login --username "$DOCKER_USER" --password-stdin

    - stage: build
      script:
        - TAG="${TRAVIS_COMMIT::8}"
        - docker build -t cmattoon/nremt-prep:latest .
        - docker tag cmattoon/nremt-prep:latest cmattoon/nremt-prep:$TAG
        
    - stage: push
      script:
        - env
        - TAG="${TRAVIS_COMMIT::8}"
        - docker push cmattoon/nremt-prep:latest
        - docker push cmattoon/nremt-prep:$TAG

stages:
  - name: import
    if: commit_message =~ /^import_questions\.py/ AND branch = master
  - name: test
  - name: build
  - name: push
    if: branch = master
    
